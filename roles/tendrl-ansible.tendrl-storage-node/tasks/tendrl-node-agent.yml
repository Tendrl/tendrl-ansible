---

- name: Install tendrl-node-agent
  yum:
    name=tendrl-node-agent
    state=latest
  notify:
   - restart rsyslog
  tags:
    - rpm-installation

- name: Configure etcd and graphite ip addr in node-agent.conf.yaml
  lineinfile:
    dest: /etc/tendrl/node-agent/node-agent.conf.yaml
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: '^etcd_connection:.*'
      line: "etcd_connection: {{ etcd_fqdn }}"
    - regexp: '^graphite_host:.*'
      line: "graphite_host: {{ graphite_fqdn }}"
  notify:
    - restart tendrl-node-agent

- name: Gather information on etcd_cert_file
  stat:
    path: "{{ etcd_cert_file }}"
  register: etcd_crt
  when: etcd_tls_client_auth|bool == True

- name: Gather information on etcd_key_file
  stat:
    path: "{{ etcd_key_file }}"
  register: etcd_key
  when: etcd_tls_client_auth|bool == True

- name: Gather information on etcd_trusted_ca_file
  stat:
    path: "{{ etcd_trusted_ca_file }}"
  register: etcd_trusted_ca_file
  when: etcd_tls_client_auth|bool == True

- name: Check that file specified in etcd_cert_file actually exists
  assert:
    that:
      - etcd_crt.stat.exists == True
    msg:
      - "File specified in etcd_cert_file doesn't exist on remote machine."
      - "Please specify path to etcd certificate file in the variable
        and rerun the playbook."
  when: etcd_tls_client_auth|bool == True

- name: Check that file specified in etcd_key_file actually exists
  assert:
    that:
      - etcd_key.stat.exists == True
    msg:
      - "File specified in etcd_key_file doesn't exist on remote machine."
      - "Please specify path to etcd key file in the variable
and rerun the playbook."
  when: etcd_tls_client_auth|bool == True

- name: Check that file specified in etcd_trusted_ca_file actually exists
  assert:
    that:
      - etcd_trusted_ca_file.stat.exists == True
    msg:
      - "File specified in etcd_trusted_ca_file doesn't exist on remote machine."
      - "Please specify path to trusted certificate authority in the variable
and rerun the playbook."
  when: etcd_tls_client_auth|bool == True

- name: Configure etcd client-server authentication
  lineinfile:
    dest: /etc/tendrl/node-agent/node-agent.conf.yaml
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: '^#? *etcd_ca_cert_file:.*'
      line: "etcd_ca_cert_file: {{ etcd_trusted_ca_file }}"
    - regexp: '^#? *etcd_cert_file:.*'
      line: "etcd_cert_file: {{ etcd_cert_file }}"
    - regexp: '^#? *etcd_key_file:.*'
      line: "etcd_key_file: {{ etcd_key_file }}"
  notify:
    - restart tendrl-node-agent
  when: etcd_tls_client_auth|bool == True

- name: Enable tendrl-node-agent service
  service:
    name=tendrl-node-agent
    enabled=yes
  tags:
    - service-enabled

- name: Start tendrl-node-agent service
  service:
    name=tendrl-node-agent
    state=started
  tags:
    - service-started
  notify:
   # workaround for case when a new tendrl-node-agent package is installed
   # during "Update all installed packages" task
   - restart rsyslog
